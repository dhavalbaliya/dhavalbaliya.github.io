name: Unpack content ZIPs

# Triggers:
# - When zips are added/changed under content/
# - Manual run (workflow_dispatch)
on:
  push:
    paths:
      - 'content/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to push to (leave empty to use current branch)'
        required: false
        default: 'main'

permissions:
  contents: write

jobs:
  unpack-zips:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository 
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and unpack ZIP files under content/
        shell: bash
        run: |
          sh zip_unzip.sh ${{ inputs.branch }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site for GitHub Pages
        run: npm run build:ghpages

      - name: Add, commit and push changes
        run: |
          # Determine branch (the branch that triggered the workflow)
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Pushing to branch: $CURRENT_BRANCH"

          git add -A

          # If no changes staged, exit gracefully
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto-update from GitHub Actions"

          # Push to same branch
          git push origin HEAD:$CURRENT_BRANCH

      # - name: Deploy to gh-pages branch
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     # You can keep github_token (auto-provided) for public repos.
      #     # For private repos you may need to use a PAT stored in secrets.
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./docs