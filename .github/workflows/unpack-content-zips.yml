name: Unpack content ZIPs

# Triggers:
# - When zips are added/changed under content/
# - Manual run (workflow_dispatch)
on:
  push:
    paths:
      - 'content/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to push to (leave empty to use current branch)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  unpack-zips:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository 
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and unpack ZIP files under content/
        shell: bash
        run: |
          set -euo pipefail

          # Determine target branch (either input or current branch)
          TARGET_BRANCH="${{ inputs.branch }}"
          if [ -z "$TARGET_BRANCH" ]; then
            # github.ref may be refs/heads/<branch> for push; default to that
            if [[ "${GITHUB_REF:-}" == refs/heads/* ]]; then
              TARGET_BRANCH="${GITHUB_REF#refs/heads/}"
            else
              TARGET_BRANCH="HEAD"
            fi
          fi
          echo "Target branch: $TARGET_BRANCH"

          # Find zip files under content/ (any depth). Use -print0 to safely handle spaces/newlines.
          mapfile -d '' zips < <(find content -type f -iname '*.zip' -print0)

          if [ "${#zips[@]}" -eq 0 ]; then
            echo "No .zip files found under content/. Nothing to do."
            exit 0
          fi

          echo "Found ${#zips[@]} zip(s) â€” processing..."
          for zip in "${zips[@]}"; do
            # Normalize path and filename
            zip="${zip/#.\//}"    # remove leading ./ if present
            echo "Processing: '$zip'"

            # basename and folder name (strip .zip or .ZIP)
            fname="$(basename -- "$zip")"
            base="${fname%.[Zz][Ii][Pp]}"   # case-insensitive strip .zip

            # Destination folder under content/
            dest="content/$base"

            # create destination and extract safely into it
            mkdir -p "$dest"
            echo "Extracting to '$dest'..."
            unzip -q -o "$zip" -d "$dest" || { echo "Failed to unzip $zip"; exit 1; }

            # Stage extracted files and remove the zip from git
            git add --all "$dest"
            git rm -f -- "$zip"
          done

          git commit -m "Unpack content ZIP(s) into content/ and remove zip file(s) [ci skip]"

          # Push to the requested branch. If TARGET_BRANCH is HEAD we push current HEAD.
          if [ "$TARGET_BRANCH" = "HEAD" ] || [ -z "$TARGET_BRANCH" ]; then
            git push
          else
            # Push local HEAD to origin/<TARGET_BRANCH>
            git push origin HEAD:"$TARGET_BRANCH"
          fi
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site for GitHub Pages
        # This should produce a ./docs directory (or whatever your publish_dir uses)
        run: npm run build:ghpages

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          # You can keep github_token (auto-provided) for public repos.
          # For private repos you may need to use a PAT stored in secrets.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs